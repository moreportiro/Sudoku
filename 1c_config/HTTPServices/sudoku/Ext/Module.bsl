// Обработчик для метода POST /hs/sudoku/wins
Функция СохранитьПобеду(Запрос) Экспорт

    // 1. Получаем тело POST-запроса в виде строки
    // В этой строке будет JSON: {"playerName": "User", "solvedAt": "..."}
    ТелоЗапроса = Запрос.ПолучитьТелоКакСтроку();

    // 2. Парсим JSON
    // Конструкция Попытка-Исключение для обработки ошибок (например, если придет невалидный JSON)
    Попытка
        ЧтениеJSON = Новый ЧтениеJSON;
        ЧтениеJSON.УстановитьСтроку(ТелоЗапроса);

        // Преобразует JSON в структуру или соответствие 1С
        ДанныеИгры = ПрочитатьJSON(ЧтениеJSON, Истина);
        ЧтениеJSON.Закрыть();
    Исключение
        // Если JSON невалидный, возвращает ошибку 400 Bad Request
        ОписаниеОшибки = "Ошибка разбора JSON: " + ОписаниеОшибки();
        Возврат СформироватьОтветС_Ошибкой(400, ОписаниеОшибки);
    КонецПопытки;

    // 3. Создает и заполняет документ
    Попытка
        НовыйДокумент = Документы.ПобедаВСудоку.СоздатьДокумент();
        НовыйДокумент.Дата = ТекущаяДата(); // Системная дата создания документа
        
        // Заполняет реквизиты из полученных данных
        НовыйДокумент.ИмяИгрока = ДанныеИгры.playerName;
        НовыйДокумент.ДатаПобеды = Дата(ДанныеИгры.solvedAt); // Преобразует строку ISO 8601 в дату 1С
        
        // 4. Записывает документ в базу данных
        НовыйДокумент.Записать();
    Исключение
        ОписаниеОшибки = "Ошибка записи документа: " + ОписаниеОшибки();
        Возврат СформироватьОтветС_Ошибкой(500, ОписаниеОшибки); // 500 - ошибка на сервере
    КонецПопытки;
        
    // 5. Формирует и возвращает успешный ответ (200 OK)
    СтруктураОтвета = Новый Структура;
    СтруктураОтвета.Вставить("message", "Победа успешно сохранена");
    СтруктураОтвета.Вставить("documentRef", НовыйДокумент.Ссылка); // Можно вернуть ссылку на созданный документ
    
    ЗаписьJSON = Новый ЗаписьJSON;
    ЗаписьJSON.УстановитьСтроку();
    ЗаписатьJSON(ЗаписьJSON, СтруктураОтвета);
    
    Ответ = Новый HTTPСервисОтвет(200);
    Ответ.УстановитьТелоИзСтроки(ЗаписьJSON.Закрыть());
    Ответ.Заголовки.Вставить("Content-type", "application/json");
    
    Возврат Ответ;

КонецФункции

// Вспомогательная функция для формирования ответов с ошибками
Функция СформироватьОтветС_Ошибкой(КодСостояния, ТекстОшибки)
    
    СтруктураОшибки = Новый Структура("error", ТекстОшибки);
    
    ЗаписьJSON = Новый ЗаписьJSON;
    ЗаписьJSON.УстановитьСтроку();
    ЗаписатьJSON(ЗаписьJSON, СтруктураОшибки);
    
    Ответ = Новый HTTPСервисОтвет(КодСостояния);
    Ответ.УстановитьТелоИзСтроки(ЗаписьJSON.Закрыть());
    Ответ.Заголовки.Вставить("Content-type", "application/json");
    
    Возврат Ответ;
    
КонецФункции