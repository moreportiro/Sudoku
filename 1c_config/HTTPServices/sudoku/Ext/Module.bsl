#Область ОБРАБОТЧИКИ_ДЛЯ_ПОЛЬЗОВАТЕЛЕЙ     
	
// Обработчик для POST http://localhost/Sudoku/hs/sudoku/users (Регистрация)
Функция СоздатьПользователя(Запрос) Экспорт
    ЧтениеJSON = Новый ЧтениеJSON;
    ЧтениеJSON.УстановитьСтроку(Запрос.ПолучитьТелоКакСтроку());
    Данные = ПрочитатьJSON(ЧтениеJSON, Истина);
    ЧтениеJSON.Закрыть();
                                                                                      
    ИмяПользователя = Данные["username"];
    ХэшПароля = Данные["password_hash"];  
	
    НовыйПользователь = Справочники.ПользователиИгры.СоздатьЭлемент();
    НовыйПользователь.Наименование = "Игрок " + ИмяПользователя;
    НовыйПользователь.Логин = ИмяПользователя;
    НовыйПользователь.ХэшПароля = ХэшПароля;
    НовыйПользователь.Записать();
    
    Ответ = Новый HTTPСервисОтвет(201);
    Возврат Ответ;
КонецФункции

// Обработчик для GET http://localhost/Sudoku/hs/sudoku/users/{username} (Получение данных для входа)         
Функция ПолучитьДанныеПользователя(Запрос) Экспорт

    Перем АйдиПользователя, ЛогинПользователя, ХэшПароляПользователя;
    ИмяПользователя = Запрос.ПараметрыURL.Получить("username");

    ЗапросБД = Новый Запрос;
    ЗапросБД.Текст =
    "ВЫБРАТЬ
    |    ПользователиИгры.Ссылка,
    |    ПользователиИгры.Логин,
    |    ПользователиИгры.ХэшПароля
    |ИЗ
    |    Справочник.ПользователиИгры КАК ПользователиИгры
    |ГДЕ
    |    ПользователиИгры.Логин = &Логин";
    ЗапросБД.УстановитьПараметр("Логин", ИмяПользователя);

    РезультатЗапроса = ЗапросБД.Выполнить();

    Если РезультатЗапроса.Пустой() Тогда
        Возврат СформироватьОтветС_Ошибкой(404, "Пользователь не найден");
    КонецЕсли;

    Выборка = РезультатЗапроса.Выбрать();
    Выборка.Следующий();
	
	АйдиПользователя = XMLСтрока(Выборка.Ссылка.УникальныйИдентификатор());
    ЛогинПользователя = XMLСтрока(Выборка.Логин);
    ХэшПароляПользователя = XMLСтрока(Выборка.ХэшПароля); 
	
	ДанныеПользователя = Новый Структура;
    ДанныеПользователя.Вставить("id", АйдиПользователя);
    ДанныеПользователя.Вставить("username", ЛогинПользователя);
    ДанныеПользователя.Вставить("password_hash", ХэшПароляПользователя);

    Возврат СформироватьОтветС_Данными(200, ДанныеПользователя);

КонецФункции  
              
#КонецОбласти

#Область ОБРАБОТЧИКИ_ДЛЯ_ПОБЕД

// Обработчик для POST http://localhost/Sudoku/hs/sudoku/wins (Сохранение победы)
Функция СохранитьПобеду(Запрос) Экспорт

    ЧтениеJSON = Новый ЧтениеJSON;
    ЧтениеJSON.УстановитьСтроку(Запрос.ПолучитьТелоКакСтроку());
    Данные = ПрочитатьJSON(ЧтениеJSON, Истина);
    ЧтениеJSON.Закрыть();
                                                                                       
    ИмяИгрока = Данные["username"];
    ДатаПобедыСтрока = Данные["solvedAt"];           
	
	СсылкаНаИгрока = Справочники.ПользователиИгры.НайтиПоРеквизиту("Логин", ИмяИгрока);
    
    Если СсылкаНаИгрока.Пустая() Тогда
        Возврат СформироватьОтветС_Ошибкой(404, "Игрок с именем '" + ИмяИгрока + "' не найден");
	КонецЕсли;                
	
	Год    = Число(Лев(ДатаПобедыСтрока, 4));
    Месяц  = Число(Сред(ДатаПобедыСтрока, 6, 2));
    День   = Число(Сред(ДатаПобедыСтрока, 9, 2));
    Час    = Число(Сред(ДатаПобедыСтрока, 12, 2));
    Минута = Число(Сред(ДатаПобедыСтрока, 15, 2));
    Секунда= Число(Сред(ДатаПобедыСтрока, 18, 2));
    
    ДатаПобедыUTC = Дата(Год, Месяц, День, Час, Минута, Секунда);
	
	ДатаПобедыМСК = ДатаПобедыUTC + (3 * 3600); 
    
    Попытка
        НовыйДокумент = Документы.ПобедаВСудоку.СоздатьДокумент();
        НовыйДокумент.Дата = ТекущаяДата();
        НовыйДокумент.ИмяИгрока = СсылкаНаИгрока;
        НовыйДокумент.ДатаПобеды = ДатаПобедыМСК;
        НовыйДокумент.Записать();
    Исключение
        Возврат СформироватьОтветС_Ошибкой(500, "Ошибка записи документа: " + ОписаниеОшибки());
    КонецПопытки;
        
    СтруктураОтвета = Новый Структура("message", "Победа успешно сохранена");
    Возврат СформироватьОтветС_Данными(200, СтруктураОтвета);

КонецФункции            

// Обработчик для GET http://localhost/Sudoku/hs/sudoku/wins?username={username} (Получение данных о победе)
Функция ПолучитьПобедыПользователя(Запрос) Экспорт
    
    ИмяИгрока = Запрос.ПараметрыЗапроса.Получить("username");
	
	СсылкаНаИгрока = Справочники.ПользователиИгры.НайтиПоРеквизиту("Логин", ИмяИгрока);
	Если СсылкаНаИгрока.Пустая() Тогда                                  
		Возврат СформироватьОтветС_Данными(200, Новый Массив);
    КонецЕсли;
    
    ЗапросБД = Новый Запрос;
    ЗапросБД.Текст = 
        "ВЫБРАТЬ
        |   ПобедаВСудоку.ДатаПобеды КАК solvedAt
        |ИЗ
        |   Документ.ПобедаВСудоку КАК ПобедаВСудоку
        |ГДЕ
        |   ПобедаВСудоку.ИмяИгрока = &Игрок
        |
        |УПОРЯДОЧИТЬ ПО
        |   solvedAt УБЫВ";
        
    ЗапросБД.УстановитьПараметр("Игрок", СсылкаНаИгрока);
    
    Результат = ЗапросБД.Выполнить().Выгрузить();
    Возврат СформироватьОтветС_Данными(200, Результат.ВыгрузитьКолонку("solvedAt"));

КонецФункции  

#КонецОбласти

#Область ВСПОМОГАТЕЛЬНЫЕ_ФУНКЦИИ

// Безопасно извлекает тело HTTP-запроса и преобразует его из строки JSON в объект 1С (Соответствие или Структура)
Функция ПолучитьДанныеИзJSON(Запрос)
    Попытка
        ЧтениеJSON = Новый ЧтениеJSON;
        ЧтениеJSON.УстановитьСтроку(Запрос.ПолучитьТелоКакСтроку());
        Данные = ПрочитатьJSON(ЧтениеJSON, Истина);
        ЧтениеJSON.Закрыть();
        Возврат Данные;
    Исключение
        Возврат Неопределено;
    КонецПопытки;
КонецФункции

// Берет любые данные 1С (Структуру, Массив и т.д.), преобразует их в строку JSON и формирует правильный HTTP-ответ с нужным кодом состояния и заголовком Content-Type.
Функция СформироватьОтветС_Данными(КодСостояния, Данные)
    ЗаписьJSON = Новый ЗаписьJSON;
    ЗаписьJSON.УстановитьСтроку();
    ЗаписатьJSON(ЗаписьJSON, Данные);
    
    Ответ = Новый HTTPСервисОтвет(КодСостояния);
    Ответ.УстановитьТелоИзСтроки(ЗаписьJSON.Закрыть());
    Ответ.Заголовки.Вставить("Content-type", "application/json");
    
    Возврат Ответ;
КонецФункции

// Создает стандартную структуру для сообщения об ошибке ({"error": "..."}) и, переиспользуя функцию СформироватьОтветС_Данными, отправляет ее клиенту.
Функция СформироватьОтветС_Ошибкой(КодСостояния, ТекстОшибки)
    СтруктураОшибки = Новый Структура("error", ТекстОшибки);
    Возврат СформироватьОтветС_Данными(КодСостояния, СтруктураОшибки);
КонецФункции

#КонецОбласти
                                                 