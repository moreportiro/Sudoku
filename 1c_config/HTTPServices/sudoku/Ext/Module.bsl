// Обработчик для метода POST /hs/sudoku/wins
Функция СохранитьПобеду(Запрос) Экспорт

    // 1. Получаем тело POST-запроса в виде строки
    // В этой строке будет JSON: {"playerName": "User", "solvedAt": "..."}
    ТелоЗапроса = Запрос.ПолучитьТелоКакСтроку();

    // 2. Парсим JSON
    // Конструкция Попытка-Исключение для обработки ошибок (например, если придет невалидный JSON)
    Попытка
        ЧтениеJSON = Новый ЧтениеJSON;
        ЧтениеJSON.УстановитьСтроку(ТелоЗапроса);

        // Преобразует JSON в структуру или соответствие 1С
        ДанныеИгры = ПрочитатьJSON(ЧтениеJSON, Истина);
        ЧтениеJSON.Закрыть();
    Исключение
        // Если JSON невалидный, возвращает ошибку 400 Bad Request
        ОписаниеОшибки = "Ошибка разбора JSON: " + ОписаниеОшибки();
        Возврат СформироватьОтветС_Ошибкой(400, ОписаниеОшибки);
    КонецПопытки;

    // 3. Создает и заполняет документ
    Попытка
        НовыйДокумент = Документы.ПобедаВСудоку.СоздатьДокумент();
        НовыйДокумент.Дата = ТекущаяДата(); // Системная дата создания документа
        
        // Заполняет реквизиты из полученных данных
        НовыйДокумент.ИмяИгрока = ДанныеИгры.playerName;
        НовыйДокумент.ДатаПобеды = Дата(ДанныеИгры.solvedAt); // Преобразует строку ISO 8601 в дату 1С
        
        // 4. Записывает документ в базу данных
        НовыйДокумент.Записать();
    Исключение
        ОписаниеОшибки = "Ошибка записи документа: " + ОписаниеОшибки();
        Возврат СформироватьОтветС_Ошибкой(500, ОписаниеОшибки); // 500 - ошибка на сервере
    КонецПопытки;
        
    // 5. Формирует и возвращает успешный ответ (200 OK)
    СтруктураОтвета = Новый Структура;
    СтруктураОтвета.Вставить("message", "Победа успешно сохранена");
    СтруктураОтвета.Вставить("documentRef", НовыйДокумент.Ссылка); // Можно вернуть ссылку на созданный документ
    
    ЗаписьJSON = Новый ЗаписьJSON;
    ЗаписьJSON.УстановитьСтроку();
    ЗаписатьJSON(ЗаписьJSON, СтруктураОтвета);
    
    Ответ = Новый HTTPСервисОтвет(200);
    Ответ.УстановитьТелоИзСтроки(ЗаписьJSON.Закрыть());
    Ответ.Заголовки.Вставить("Content-type", "application/json");
    
    Возврат Ответ;

КонецФункции

// Вспомогательная функция для формирования ответов с ошибками
Функция СформироватьОтветС_Ошибкой(КодСостояния, ТекстОшибки)
    
    СтруктураОшибки = Новый Структура("error", ТекстОшибки);
    
    ЗаписьJSON = Новый ЗаписьJSON;
    ЗаписьJSON.УстановитьСтроку();
    ЗаписатьJSON(ЗаписьJSON, СтруктураОшибки);
    
    Ответ = Новый HTTPСервисОтвет(КодСостояния);
    Ответ.УстановитьТелоИзСтроки(ЗаписьJSON.Закрыть());
	
    Ответ.Заголовки.Вставить("Content-type", "application/json");
    
    Возврат Ответ;
    
КонецФункции

// Обработчик для POST /hs/sudoku/users (Регистрация)
Функция СоздатьПользователя(Запрос) Экспорт
    
    // Получаем тело запроса ({"username": "...", "password_hash": "..."})
    Данные = ПолучитьДанныеИзJSON(Запрос);
    Если Данные = Неопределено Тогда
        Возврат СформироватьОтветС_Ошибкой(400, "Некорректный JSON");
    КонецЕсли;

    // Проверяем, существует ли уже такой пользователь
    ЗапросБД = Новый Запрос;
    ЗапросБД.Текст = 
        "ВЫБРАТЬ
        |   ПользователиИгры.Ссылка
        |ИЗ
        |   Справочник.ПользователиИгры КАК ПользователиИгры
        |ГДЕ
        |   ПользователиИгры.Логин = &Логин";
    ЗапросБД.УстановитьПараметр("Логин", Данные.username);
    
    Если НЕ ЗапросБД.Выполнить().Пустой() Тогда
        Возврат СформироватьОтветС_Ошибкой(400, "Пользователь с таким именем уже существует");
    КонецЕсли;
    
    // Создаем нового пользователя
    НовыйПользователь = Справочники.ПользователиИгры.СоздатьЭлемент();
    НовыйПользователь.Наименование = "Игрок " + Данные.username; // Заполняем обязательное поле
    НовыйПользователь.Логин = Данные.username;
    НовыйПользователь.ХэшПароля = Данные.password_hash;
    
    Попытка
        НовыйПользователь.Записать();
    Исключение
        Возврат СформироватьОтветС_Ошибкой(500, "Не удалось создать пользователя: " + ОписаниеОшибки());
    КонецПопытки;
    
    Возврат СформироватьОтветС_Данными(201, Новый Структура("message", "Пользователь успешно создан"));

КонецФункции

// Обработчик для GET /hs/sudoku/users/{username} (Получение хэша для входа)
Функция ПолучитьДанныеПользователя(Запрос) Экспорт
    
    ИмяПользователя = Запрос.ПараметрыURL.Получить("username");
    
    ЗапросБД = Новый Запрос;
    ЗапросБД.Текст = 
        "ВЫБРАТЬ
        |   ПользователиИгры.Ссылка КАК id,
        |   ПользователиИгры.Логин КАК username,
        |   ПользователиИгры.ХэшПароля КАК password_hash
        |ИЗ
        |   Справочник.ПользователиИгры КАК ПользователиИгры
        |ГДЕ
        |   ПользователиИгры.Логин = &Логин";
    ЗапросБД.УстановитьПараметр("Логин", ИмяПользователя);
    
    Результат = ЗапросБД.Выполнить().Выгрузить();
    
    Если Результат.Количество() = 0 Тогда
        Возврат СформироватьОтветС_Ошибкой(404, "Пользователь не найден");
    КонецЕсли;
    
    // Возвращаем данные пользователя (включая хэш) в формате JSON
    Возврат СформироватьОтветС_Данными(200, Результат[0]);

КонецФункции

// Универсальная вспомогательная функция для получения данных из JSON
Функция ПолучитьДанныеИзJSON(Запрос)
    Попытка
        ЧтениеJSON = Новый ЧтениеJSON;
        ЧтениеJSON.УстановитьСтроку(Запрос.ПолучитьТелоКакСтроку());
        Данные = ПрочитатьJSON(ЧтениеJSON, Истина);
        ЧтениеJSON.Закрыть();
        Возврат Данные;
    Исключение
        Возврат Неопределено;
    КонецПопытки;
КонецФункции

// Универсальная вспомогательная функция для отправки данных в JSON
Функция СформироватьОтветС_Данными(КодСостояния, Данные)
    ЗаписьJSON = Новый ЗаписьJSON;
    ЗаписьJSON.УстановитьСтроку();
    ЗаписатьJSON(ЗаписьJSON, Данные);
    
    Ответ = Новый HTTPСервисОтвет(КодСостояния);
    Ответ.УстановитьТелоИзСтроки(ЗаписьJSON.Закрыть());
    Ответ.Заголовки.Вставить("Content-type", "application/json");
    
    Возврат Ответ;
КонецФункции

// Обработчик для GET /hs/sudoku/wins?username=...
Функция ПолучитьПобедыПользователя(Запрос) Экспорт
    
    // Получаем имя пользователя из параметров URL (?username=...)
    ИмяИгрока = Запрос.ПараметрыЗапроса.Получить("username");
    
	Если ИмяИгрока = Неопределено Тогда
		
        Возврат СформироватьОтветС_Ошибкой(400, "Не указан параметр 'username'");
		
    КонецЕсли;
    
    // Создаем запрос к базе данных 1С
    ЗапросБД = Новый Запрос;
    ЗапросБД.Текст = 
        "ВЫБРАТЬ
        |   ПобедаВСудоку.ДатаПобеды КАК solvedAt
        |ИЗ
        |   Документ.ПобедаВСудоку КАК ПобедаВСудоку
        |ГДЕ
        |   ПобедаВСудоку.ИмяИгрока = &ИмяИгрока
        |
        |УПОРЯДОЧИТЬ ПО
        |   solvedAt УБЫВ"; // Сортируем по убыванию, чтобы новые были сверху
        
    ЗапросБД.УстановитьПараметр("ИмяИгрока", ИмяИгрока);
    
    Результат = ЗапросБД.Выполнить().Выгрузить();
    
    // Возвращаем результат (массив побед) в формате JSON
    Возврат СформироватьОтветС_Данными(200, Результат.ВыгрузитьКолонку("solvedAt"));

КонецФункции